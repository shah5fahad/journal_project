{% extends "basecode.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Welcome, {{ current_user.username }}</h2>
    <p class="text-muted">You are logged in as <strong>{{ current_user.role }}</strong>.</p>

    {% if is_admin %}
    <!-- Add User Form -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4>Add New User</h4>
        </div>
        <div class="card-body">
            <br>
            <form id="myForm" method="POST" action="{{ url_for('add_user') }}">
                <div class="row g-2">
                    <style>
                        .invalid-input {
                            border: 2px solid red !important;
                        }
                    </style>
                    <span class="form-text text-muted small">
                        lowercase, no spaces (a–z, 0–9, _)
                    </span>
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="username" id="username" 
                               placeholder="Username" required>
                        
                    </div>
                    
                    <style>
                        .invalid-input {
                            border: 2px solid red;
                        }
                        .valid-input {
                            border: 2px solid green;
                        }
                    </style>
                    
                    <script>
                        const usernameInput = document.getElementById("username");
                        const form = document.getElementById("myForm");
                    
                        usernameInput.addEventListener("input", function() {
                            // valid characters = lowercase letters, numbers, underscore
                            let cleaned = this.value.toLowerCase().replace(/[^a-z0-9_]/g, "");
                            this.value = cleaned; // update cleaned value
                    
                            // check validity
                            if (cleaned.length < 6) {
                                this.classList.add("invalid-input");
                                this.classList.remove("valid-input");
                            } else {
                                this.classList.remove("invalid-input");
                                this.classList.add("valid-input");
                            }
                        });
                    
                        // prevent form submission if username < 6 characters
                        form.addEventListener("submit", function(event) {
                            if (usernameInput.value.length < 6) {
                                event.preventDefault(); // stop submission
                                alert("Username must be at least 6 characters long!");
                            }
                        });
                    </script>
                    
                    <div class="col-md-3">
                        <input type="email" class="form-control" name="email" id="email"
                               placeholder="Email" required
                               oninput="this.value = this.value.toLowerCase()">
                    </div>
                    
                    <div class="col-md-3 position-relative">
                        <input type="password" class="form-control" id="password" name="password" placeholder="Password" required>
                        <span class="position-absolute top-50 end-0 translate-middle-y me-3" style="cursor: pointer;" onclick="togglePassword()">
                            <i class="bi bi-eye" id="toggleIcon"></i>
                        </span>
                    </div>
                    
                    <script>
                    function togglePassword() {
                        const passwordField = document.getElementById('password');
                        const icon = document.getElementById('toggleIcon');
                        if (passwordField.type === 'password') {
                            passwordField.type = 'text';
                            icon.classList.remove('bi-eye');
                            icon.classList.add('bi-eye-slash');
                        } else {
                            passwordField.type = 'password';
                            icon.classList.remove('bi-eye-slash');
                            icon.classList.add('bi-eye');
                        }
                    }
                    </script>
                    
                    <div class="col-md-2">
                        <select class="form-select" name="role">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="col-md-1 d-grid">
                        <button type="submit" class="btn btn-success">Add</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- User List -->
    <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">
            <h4>User List</h4>
        </div>
        <div class="card-body">
            {% if users %}
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>{{ user.email }}</td>
                        <td>
                            {% if user.role == 'admin' %}
                                <span class="badge bg-danger">Admin</span>
                            {% else %}
                                <span class="badge bg-info text-dark">User</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('edit_user', username=user.username) }}" class="btn btn-sm btn-primary">Edit</a>
                            {% if user.username != current_user.username %}
                            <a href="{{ url_for('delete_user', username=user.username) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
                <p class="text-muted">No users found.</p>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="alert alert-info mt-4">
        You are logged in as a regular user. Only admins can manage users.
    </div>
    {% endif %}
</div>
{% endblock %}
